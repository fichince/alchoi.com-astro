---
import NavbarLayout from '@src/layouts/NavbarLayout.astro';
import { getCollection, getEntryBySlug } from 'astro:content';
import MD from '@src/components/MD.astro';
import { Picture } from '@astrojs/image/components';
import CoolBackground from '@src/components/CoolBackground.astro';
import About from '@src/components/About.astro';
import IntroSection from '@src/components/IntroSection.astro';
import OpenBook from '@src/components/icons/OpenBook.astro';

const prose = await getCollection('prose');

const intro = await getEntryBySlug('other', 'prose-intro');
const title = intro.data.title;
const meta = { description: title };

const book = await getEntryBySlug('other', 'jacob-rob');
const { Content: Book } = await book.render();

---
<NavbarLayout title="Prose" meta={meta}>
  <main class="tw-container container fade-in">
    <IntroSection intro={intro}>
      <OpenBook />
    </IntroSection>

    <section class="hero">
      <h2>
        <a href={book.data.url}>
          {book.data.title}
        </a>
      </h2>
      <div class="hero-body">
        <div class="image-hover">
          <Picture
            src={book.data.image}
            alt={book.data.title}
            widths={[320]}
            aspectRatio="1:1"
            sizes="320px"
          />
        </div>
        <div class="tw-prose">
          <Book />
        </div>
      </div>
    </section>

    <section class="stories"
      x-data="{ bgShift: -1, bgHover: 0}"
      x-bind:data-bg-shift="bgShift"
      x-bind:data-bg-hover="bgHover"
      x-on:mouseenter="bgHover = 1"
      x-on:mouseleave="bgHover = 0">
      { prose.map(async (item, index) => {

        const link = item.data.url;
        const { Content } = await item.render();

        return (
          <article x-on:mouseover={`bgShift = ${index}`} class="fade-in">
            <div class="image image-hover">
              <a href={link}>
                <Picture
                  src={item.data.image}
                  alt={item.data.title}
                  widths={[480]}
                  aspectRatio="1:1"
                  sizes="480px"
                />
              </a>
            </div>
            <h2>
              <a href={link}>
                <MD md={item.data.title} />
              </a>
            </h2>
            <h3>
              <MD md={item.data.description} />
            </h3>
            <div class="excerpt tw-prose">
              <Content />
            </div>
          </article>
        );
      })}
    </section>
    <CoolBackground />
  </main>
  <section>
    <About />
  </section>
</NavbarLayout>

<style lang="scss">
  @import "../style/mixins.scss";

  .container {
    font-family: var(--font-body);

    margin-left: auto;
    margin-right: auto;
    padding: var(--size-fluid-4) 0;

    h1 {
      font-family: var(--font-display);
      font-size: var(--font-size-fluid-1);

      margin: 0 var(--size-fluid-4) var(--size-fluid-4);
      font-weight: bold;
    }

    section {
      border-top: 1px solid var(--primary-light);
      padding: var(--size-fluid-1) 0;
    }

    section.hero {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      padding: 0 var(--size-fluid-3);

      a {
        @include hover-link;
        text-decoration: underline;
      }

      h2 {
        font-family: var(--font-display);
        font-size: var(--font-size-fluid-2);
        margin-bottom: 2rem;
        text-align: center;
      }

      .hero-body {
        :first-child {
          margin-right: 0;
          margin-top: var(--size-fluid-3);

          @include sm-up {
            margin-top: 0;
            margin-right: var(--size-fluid-3);
          }
        }
        display: flex;
        flex-direction: column;
        align-items: center;

        @include sm-up {
          flex-direction: row;
        }
      }
    }

    section.stories {
      padding: var(--size-fluid-2);

      display: grid;
      grid-template-columns: 1fr;
      @include sm-up {
        grid-template-columns: repeat(3, 1fr);
      }
      gap: var(--size-fluid-2);

      article {
        @include hover-background($c: var(--highlight-dark));
        padding: var(--size-fluid-2);
        font-size: var(--font-size-fluid-0);

        @for $i from 1 through 20 {
          &:nth-child(#{$i}) {
            animation-delay: calc($i * 200ms);
          }
        }

        .image {
          margin-bottom: var(--size-5);
        }

        a {
          @include hover-link;
          text-decoration: underline;
        }

        h2 {
          font-family: var(--font-display);
          font-size: var(--font-size-fluid-1);
          margin-bottom: 0.5rem;
        }

        h3 {
          font-size: var(--font-size-fluid-0);
          font-weight: 500;
          margin-bottom: 1rem;
        }
      }

    }
  }
</style>